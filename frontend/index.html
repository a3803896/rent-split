<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>Â∞èÂ±ãË®òÂ∏≥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .section-title {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .list-group-item {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        .card {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
        }

        .card-body ul.list-group {
            margin-top: 0.5rem;
        }

        .table th,
        .table td {
            vertical-align: middle;
        }

        .btn-link {
            text-decoration: none;
            font-weight: bold;
        }

        .form-label {
            font-weight: 500;
        }

        .badge {
            font-size: 0.85rem;
            padding: 0.3em 0.5em;
        }
    </style>
</head>

<body>
    <div id="app" class="container py-4">
        <section>
            <!-- ‚úÖ ÊàøÈñìËàá‰ΩèÊà∂ÁÆ°ÁêÜÔºàÂèØÊë∫ÁñäÔºâ -->
            <div class="section-title">üè† ÊàøÂÆ¢ÁÆ°ÁêÜ</div>
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" @click="showManage = !showManage" style="cursor: pointer;">
                            {{ showManage ? '‚ñº' : '‚ñ∂' }} ‰ΩèÊà∂ {{ users.length }} ‰∫∫ / ÊàøÈñì {{ rooms.length }} Èñì
                        </h5>
                    </div>
                    <div v-if="showManage" class="row g-4 mb-4 mt-3">
                        <!-- ‰ΩèÊà∂ÁÆ°ÁêÜ -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">üë§ ‰ΩèÊà∂ÁÆ°ÁêÜ</h5>
                                    <form class="mb-3" @submit.prevent="addUser">
                                        <div class="input-group">
                                            <input v-model="newUser.name" type="text" class="form-control"
                                                placeholder="‰ΩèÊà∂ÂêçÁ®±" required />
                                            <button class="btn btn-primary" type="submit">Êñ∞Â¢û</button>
                                        </div>
                                    </form>
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center"
                                            v-for="user in users" :key="user.id">
                                            {{ user.name }}
                                            <button class="btn btn-sm btn-outline-danger"
                                                @click="deleteUser(user.id)">Âà™Èô§</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ÊàøÈñìÁÆ°ÁêÜ -->
                        <div class="col-md-6">
                            <!-- ÂéüÊú¨ÊàøÈñìÁÆ°ÁêÜÁöÑÂç°ÁâáÂÖßÂÆπÔºåÂéªÊéâÂ§ñÂ±§ÁöÑ card mb-4 ÂåÖË£ùÔºåÂè™‰øùÁïô card-body ÂÖßÈÉ® -->
                            <div class="card">
                                <div class="card-body">
                                    <!-- Êñ∞Â¢ûÊàøÈñìË°®ÂñÆ + ÊàøÈñìÂàóË°® -->
                                    <h5 class="card-title">üè† ÊàøÈñìÁÆ°ÁêÜ</h5>
                                    <form class="row g-2 align-items-end mb-3" @submit.prevent="addRoom">
                                        <div class="input-group">
                                            <input v-model="newRoom.name" type="text" class="form-control"
                                                placeholder="ÊàøÈñìÂêçÁ®±" required />
                                            <button class="btn btn-primary">Êñ∞Â¢û</button>
                                        </div>
                                    </form>
                                    <div v-if="rooms.length" class="row g-2">
                                        <div class="col-12" v-for="room in rooms" :key="room.id">
                                            <div class="border p-3 rounded mb-2">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <strong>{{ room.name }}</strong>
                                                    <button class="btn btn-sm btn-outline-danger"
                                                        @click="deleteRoom(room.id)">Âà™Èô§</button>
                                                </div>
                                                <div class="mb-2">
                                                    <span v-for="user in users.filter(u => u.room_id === room.id)"
                                                        :key="user.id" class="badge bg-secondary me-1">
                                                        {{ user.name }}
                                                        <button class="btn btn-sm btn-link text-white p-0 ms-1"
                                                            @click="unbindUserFromRoom(user.id)">√ó</button>
                                                    </span>
                                                </div>
                                                <div class="input-group input-group-sm">
                                                    <select class="form-select" v-model="roomAssignments[room.id]">
                                                        <option disabled value="">ÈÅ∏Êìá‰ΩèÊà∂</option>
                                                        <option v-for="user in users.filter(u => !u.room_id)"
                                                            :value="user.id">
                                                            {{ user.name }}
                                                        </option>
                                                    </select>
                                                    <button class="btn btn-primary"
                                                        @click="assignUserToRoom(room.id, roomAssignments[room.id]); roomAssignments[room.id]=''">
                                                        Âä†ÂÖ•
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Â∑≤Â∞ÅÂ≠òÊ¨æÈ†ÖÔºàÂèØÊë∫ÁñäÔºâ -->
            <div class="section-title">üì¶ Â∑≤Â∞ÅÂ≠òÊ¨æÈ†Ö</div>
            <div class="card mb-4">
                <div class="card-body">
                    <!-- ÂçÄÂ°äÊ®ôÈ°å + Êë∫ÁñäÂàáÊèõ + ÊâπÊ¨°ÈÇÑÂéüÊåâÈàï -->
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" @click="showArchived = !showArchived" style="cursor: pointer;">
                            {{ showArchived ? '‚ñº' : '‚ñ∂' }} Â∞ÅÂ≠òÊ¨æÈ†ÖÔºà{{ archivedPayments.length }} Á≠ÜÔºâ
                        </h5>
                        <button v-if="showArchived" class="btn btn-outline-success btn-sm"
                            :disabled="archivedSelected.length === 0" @click="unarchiveSelectedPayments">
                            ÈÇÑÂéüÊâÄÈÅ∏
                        </button>
                    </div>

                    <!-- üìã Â∞ÅÂ≠òÊ¨æÈ†ÖË≥áÊñôË°®ÔºàÂÉÖÂú®Â±ïÈñãÊôÇÈ°ØÁ§∫Ôºâ -->
                    <div v-if="showArchived" class="table-responsive mt-2">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th><input type="checkbox"
                                            @change="toggleArchivedSelectAll($event.target.checked)" /></th>
                                    <th>Êó•Êúü</th>
                                    <th>Ê¨æÈ†Ö</th>
                                    <th>ÈáëÈ°ç</th>
                                    <th>Áπ≥Ê¨æ‰∫∫</th>
                                    <th>ÂàÜÂ∏≥‰∫∫</th>
                                    <th>ÂÇôË®ª</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in archivedPayments" :key="item.id">
                                    <td><input type="checkbox" :value="item.id" v-model="archivedSelected" /></td>
                                    <td>{{ item.date }}</td>
                                    <td>{{ item.category }}</td>
                                    <td>{{ item.amount }}</td>
                                    <td>{{ item.payer_name }}</td>
                                    <td>
                                        <template v-if="item.split_by === 'room'">
                                            <div v-for="grp in item.split_per_room" :key="grp.room_id" class="mb-2">
                                                <strong>{{ grp.room_name }}Ôºö</strong>
                                                <span v-for="u in grp.users" :key="u.id"
                                                    class="badge bg-secondary me-1">
                                                    {{ u.name }} (${{ u.amount }})
                                                </span>
                                            </div>
                                        </template>
                                        <template v-else>
                                            <span v-for="u in item.split_users" :key="u.id"
                                                class="badge bg-secondary me-1">
                                                {{ u.name }} (${{ u.amount }})
                                            </span>
                                        </template>
                                    </td>
                                    <td>{{ item.note }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger"
                                            @click="deleteArchivedPayment(item.id)">
                                            Âà™Èô§
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Â∏∏Áî®Ê¨æÈ†ÖÔºàÂèØÊë∫ÁñäÔºâ -->
            <div class="section-title">‚≠ê Â∏∏Áî®Ê¨æÈ†Ö</div>
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Ê®ôÈ°åÂçÄÂ°äÔºöÈªûÊìäÂèØÂ±ïÈñã/Êë∫Áñä -->
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" @click="showFavorites = !showFavorites" style="cursor: pointer;">
                            {{ showFavorites ? '‚ñº' : '‚ñ∂' }} Â∏∏Áî®Ê¨æÈ†ÖÔºà{{ favoritePayments.length }} Á≠ÜÔºâ
                        </h5>
                    </div>

                    <!-- Ë°®Ê†ºÂÖßÂÆπÔºàÂÉÖÂ±ïÈñãÊôÇÈ°ØÁ§∫Ôºâ -->
                    <div v-if="showFavorites" class="mt-3">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>Áπ≥Ê¨æ‰∫∫</th>
                                    <th>Ê¨æÈ†Ö</th>
                                    <th>ÈáëÈ°ç</th>
                                    <th>ÂÇôË®ª</th>
                                    <th>ÂàÜÂ∏≥Â∞çË±°</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, i) in favoritePayments" :key="i">
                                    <td>{{ getUserName(item.payer_id) }}</td>
                                    <td>{{ item.category }}</td>
                                    <td>${{ item.amount }}</td>
                                    <td>{{ item.note }}</td>
                                    <td>
                                        <template v-if="item.split_by === 'room'">
                                            <template v-for="(rid, idx) in item.splitRooms" :key="rid">
                                                <strong>{{ getRoomNameById(rid) }}Ôºö</strong>
                                                <span v-for="u in users.filter(u => u.room_id === rid)" :key="u.id"
                                                    class="badge bg-secondary me-1">
                                                    {{ u.name }} (${{ ((item.amount/item.splitRooms.length) /
                                                    users.filter(u => u.room_id === rid).length) }})
                                                </span>
                                                <span v-if="idx < item.splitRooms.length - 1">„ÄÅ</span>
                                            </template>
                                        </template>
                                        <template v-else>
                                            <span v-for="(uid, i) in item.splitUsers" :key="uid"
                                                class="badge bg-secondary me-1">
                                                {{ getUserName(uid) }} (${{ (item.amount/item.splitUsers.length) }})
                                            </span>
                                        </template>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="selectFavorite(item)">ÂèñÁî®</button>
                                        &nbsp;
                                        <button class="btn btn-sm btn-outline-danger"
                                            @click="removeFavorite(i)">Âà™Èô§</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Áî®Êà∂ËàáÊñ∞Â¢ûÊ¨æÈ†ÖÂçÄÂ°ä -->
            <div class="row g-4 mb-4">
                <!-- ‚ûï Êñ∞Â¢ûÊ¨æÈ†ÖÔºàÂè≥ÂÅ¥Ôºâ -->
                <div class="col-md-12">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">‚ûï Êñ∞Â¢ûÊ¨æÈ†Ö</h5>
                            <form @submit.prevent="addPayment">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Áπ≥Ê¨æ‰∫∫</label>
                                        <select v-model="newPayment.payer_id" class="form-select" required>
                                            <option disabled value="">Ë´ãÈÅ∏Êìá</option>
                                            <option v-for="user in users" :value="user.id">{{ user.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Ê¨æÈ†Ö</label>
                                        <input v-model="newPayment.category" type="text" class="form-control"
                                            placeholder="Â¶Ç Ê∞¥Èõª„ÄÅÁ∂≤Ë∑Ø">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ÈáëÈ°ç</label>
                                        <input v-model.number="newPayment.amount" type="number" class="form-control"
                                            required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Êó•Êúü</label>
                                        <input v-model="newPayment.date" type="date" class="form-control" required>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">ÂÇôË®ª</label>
                                        <input v-model="newPayment.note" type="text" class="form-control">
                                    </div>

                                    <!-- ÂàÜÂ∏≥ÊñπÂºèÂàáÊèõ -->
                                    <div class="col-12">
                                        <label class="form-label">ÂàÜÂ∏≥ÊñπÂºè</label> &nbsp;
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="splitByUser" value="user"
                                                v-model="newPayment.split_by">
                                            <label class="form-check-label" for="splitByUser">Êåâ‰∫∫È†≠</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="splitByRoom" value="room"
                                                v-model="newPayment.split_by">
                                            <label class="form-check-label" for="splitByRoom">ÊåâÊàøÈñì</label>
                                        </div>
                                    </div>

                                    <!-- üë• Êåâ‰∫∫È†≠ÂàÜÂ∏≥ÔºöÂãæÈÅ∏‰∫∫Âì° -->
                                    <div class="col-12" v-if="newPayment.split_by === 'user'">
                                        <label class="form-label">ÂèÉËàáÂàÜÂ∏≥ËÄÖ</label>
                                        <div class="row">
                                            <div class="col-6 col-md-4" v-for="user in users" :key="'split-' + user.id">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                        :id="'split-user-' + user.id" :value="user.id"
                                                        v-model="newPayment.splitUsers">
                                                    <label class="form-check-label" :for="'split-user-' + user.id">
                                                        {{ user.name }}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- üè† ÊåâÊàøÈñìÂàÜÂ∏≥ÔºöÈÅ∏ÊìáÊàøÈñì -->
                                    <div class="col-12" v-if="newPayment.split_by === 'room'">
                                        <label class="form-label">ÈÅ∏ÊìáË¶ÅÂàÜÂ∏≥ÁöÑÊàøÈñì</label>
                                        <div class="form-check" v-for="room in rooms" :key="room.id">
                                            <input class="form-check-input" type="checkbox"
                                                :id="`split-room-${room.id}`" :value="room.id"
                                                v-model="newPayment.splitRooms" />
                                            <label class="form-check-label" :for="`split-room-${room.id}`">
                                                {{ room.name }}Ôºà
                                                {{ getUsersInRoom(room.id).map(u => u.name).join('„ÄÅ') }}
                                                Ôºâ
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Êèê‰∫§ÊåâÈàï -->
                                <div class="d-grid mt-4">
                                    <button class="btn btn-success">Êñ∞Â¢ûÊ¨æÈ†Ö</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Ê¨æÈ†ÖÁ¥ÄÈåÑÂçÄÂ°ä -->
            <div class="section-title">üìë Ê¨æÈ†ÖÁ¥ÄÈåÑ</div>
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Â∞ÅÂ≠òÊåâÈàï -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">ÊâÄÊúâÊ¨æÈ†Ö</h5>
                        <button class="btn btn-warning btn-sm" :disabled="selectedPayments.length === 0"
                            @click="archiveSelectedPayments">
                            Â∞ÅÂ≠òÊâÄÈÅ∏
                        </button>
                    </div>

                    <!-- Ë°®Ê†ºÂÖßÂÆπ -->
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" @change="toggleSelectAll($event.target.checked)" /></th>
                                    <th>Êó•Êúü</th>
                                    <th>Ê¨æÈ†Ö</th>
                                    <th>ÈáëÈ°ç</th>
                                    <th>Áπ≥Ê¨æ‰∫∫</th>
                                    <th>ÂàÜÂ∏≥Â∞çË±°</th>
                                    <th>ÂÇôË®ª</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in payments" :key="item.id">
                                    <!-- ‚úÖ Â§öÈÅ∏ÂãæÈÅ∏Ê°Ü -->
                                    <td>
                                        <input type="checkbox" :value="item.id" v-model="selectedPayments" />
                                    </td>

                                    <!-- üìÖ Êó•ÊúüËàáÊ¨æÈ†ÖÈáëÈ°çË≥áË®ä -->
                                    <td>{{ item.date }}</td>
                                    <td>{{ item.category }}</td>
                                    <td>{{ item.amount }}</td>

                                    <!-- üí∞ Áπ≥Ê¨æ‰∫∫ -->
                                    <td>{{ item.payer_name }}</td>

                                    <!-- üë• ÂàÜÂ∏≥Â∞çË±° -->
                                    <td>
                                        <template v-if="item.split_by === 'room'">
                                            <div v-for="grp in item.split_per_room" :key="grp.room_id" class="mb-2">
                                                <strong>{{ grp.room_name }}Ôºö</strong>
                                                <span v-for="u in grp.users" :key="u.id"
                                                    class="badge bg-secondary me-1">
                                                    {{ u.name }} ${{ u.amount }}
                                                </span>
                                            </div>
                                        </template>
                                        <template v-else>
                                            <span v-for="u in item.split_users" :key="u.id"
                                                class="badge bg-secondary me-1">
                                                {{ u.name }} ${{ u.amount }}
                                            </span>
                                        </template>
                                    </td>

                                    <!-- üìù ÂÇôË®ª -->
                                    <td>{{ item.note }}</td>

                                    <!-- ‚öôÔ∏è Êìç‰Ωú -->
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="addToFavorites(item)">
                                            Âä†ÂÖ•Â∏∏Áî®
                                        </button>
                                        &nbsp;
                                        <button class="btn btn-sm btn-outline-danger" @click="deletePayment(item.id)">
                                            Âà™Èô§
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ ÁµêÁÆóË°®ÂçÄÂ°ä -->
            <div class="section-title">üìä ÁµêÁÆóË°®</div>
            <div class="card mb-5">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>ÂßìÂêç</th>
                                    <th>‰ª£Â¢äÈáëÈ°ç</th>
                                    <th>Êáâ‰ªòÈáëÈ°ç</th>
                                    <th>Ê∑®È°ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in summary" :key="item.name">
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.paid }}</td>
                                    <td>{{ item.owed }}</td>
                                    <td :class="{ 'text-danger': item.net < 0, 'text-success': item.net > 0 }">
                                        {{ item.net }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <script>
            const { createApp, ref, onMounted } = Vue;

            createApp({
                setup() {
                    // ===========================
                    // üì¶ 1. Reactive ÁãÄÊÖãËÆäÊï∏ÂÆ£Âëä
                    // ===========================
                    const users = ref([]);
                    const newUser = ref({ name: '' });

                    const rooms = ref([]);
                    const newRoom = ref({ name: '' });
                    const roomAssignments = ref({});

                    const payments = ref([]);
                    const selectedPayments = ref([]);

                    const newPayment = ref({
                        payer_id: '',
                        amount: '',
                        category: '',
                        date: new Date().toISOString().slice(0, 10),
                        note: '',
                        split_by: 'user',
                        splitUsers: [],
                        splitRooms: []
                    });

                    const summary = ref([]);

                    const showFavorites = ref(false);
                    const favoritePayments = ref([]);

                    const showArchived = ref(false);
                    const archivedPayments = ref([]);
                    const archivedSelected = ref([]);
                    const showManage = ref(false);

                    // ===========================
                    // üß≠ 2. ‰ΩøÁî®ËÄÖËàáÊàøÈñìÁÆ°ÁêÜ
                    // ===========================
                    const loadUsers = async () => {
                        const res = await fetch('http://localhost:3001/users');
                        users.value = await res.json();
                    };

                    const loadRooms = async () => {
                        const res = await fetch('http://localhost:3001/rooms');
                        rooms.value = await res.json();
                    };

                    const addUser = async () => {
                        if (!newUser.value.name) return;
                        await fetch('http://localhost:3001/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newUser.value)
                        });
                        newUser.value = { name: '' };
                        await loadUsers();
                    };

                    const deleteUser = async (id) => {
                        if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄô‰Ωç‰ΩèÊà∂ÂóéÔºü')) return;
                        await fetch(`http://localhost:3001/users/${id}`, { method: 'DELETE' });
                        await loadUsers();
                    };

                    const addRoom = async () => {
                        if (!newRoom.value.name) return;
                        await fetch('http://localhost:3001/rooms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newRoom.value)
                        });
                        newRoom.value.name = '';
                        await loadRooms();
                    };

                    const deleteRoom = async (id) => {
                        if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊàøÈñìÔºü')) return;
                        await fetch(`http://localhost:3001/rooms/${id}`, { method: 'DELETE' });
                        await loadRooms();
                        await loadUsers();
                    };

                    const assignUserToRoom = async (roomId, user_id) => {
                        if (!user_id) return;
                        await fetch(`http://localhost:3001/users/${user_id}/assign-room`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ roomId })
                        });
                        await loadUsers();
                    };

                    const unbindUserFromRoom = async (user_id) => {
                        await fetch(`http://localhost:3001/users/${user_id}/remove-room`, { method: 'POST' });
                        await loadUsers();
                    };

                    const getUsersInRoom = (roomId) => {
                        return users.value.filter(u => u.room_id === roomId)
                    }

                    const getRoomNameById = (roomId) => {
                        const room = rooms.value.find(r => r.id === roomId)
                        return room ? room.name : 'Êú™Áü•ÊàøÈñì'
                    }

                    // ===========================
                    // üí∏ 3. Ê¨æÈ†ÖÁõ∏ÈóúÂäüËÉΩ
                    // ===========================
                    const loadPayments = async () => {
                        const res = await fetch('http://localhost:3001/payments-with-users');
                        payments.value = await res.json();
                    };

                    const addPayment = async () => {
                        const payload = { ...newPayment.value };

                        if (!payload.payer_id || !payload.amount || !payload.date) {
                            alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áË®ä');
                            return;
                        }

                        if (payload.split_by === 'user' && (!payload.splitUsers || payload.splitUsers.length === 0)) {
                            alert('Ë´ãÈÅ∏ÊìáËá≥Â∞ë‰∏Ä‰ΩçÂàÜÂ∏≥‰ΩèÊà∂');
                            return;
                        }

                        if (payload.split_by === 'room' && (!payload.splitRooms || payload.splitRooms.length === 0)) {
                            alert('Ë´ãÈÅ∏ÊìáËá≥Â∞ë‰∏ÄÂÄãÊàøÈñì');
                            return;
                        }

                        try {
                            await fetch('http://localhost:3001/payments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            alert('‚úÖ Ê¨æÈ†ÖÊñ∞Â¢ûÊàêÂäüÔºÅ');
                            newPayment.value = {
                                payer_id: '', amount: '', category: '', date: new Date().toISOString().slice(0, 10),
                                note: '', split_by: 'user', splitUsers: [], splitRooms: []
                            };
                            await loadPayments();
                            await loadSummary();
                        } catch (err) {
                            console.error(err);
                            alert('‚ùå Êñ∞Â¢ûÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÂæåÁ´Ø API');
                        }
                    };

                    const deletePayment = async (id) => {
                        if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊ¨æÈ†ÖÂóéÔºü')) return;
                        await fetch(`http://localhost:3001/payments/${id}`, { method: 'DELETE' });
                        await loadPayments();
                        await loadSummary();
                    };

                    const deleteArchivedPayment = async (id) => {
                        if (!confirm('Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§ÈÄôÁ≠ÜÂ∞ÅÂ≠òÊ¨æÈ†ÖÂóéÔºü')) return;
                        try {
                            await fetch(`http://localhost:3001/payments/${id}`, { method: 'DELETE' });
                            // ÈáçÊñ∞ËºâÂÖ•Â∞ÅÂ≠òÊ∏ÖÂñÆ
                            await loadArchivedPayments();
                        } catch (err) {
                            console.error(err);
                            alert('Âà™Èô§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                        }
                    };

                    // ===========================
                    // üßæ 4. Áµ±Ë®àË≥áÊñô
                    // ===========================
                    const loadSummary = async () => {
                        const res = await fetch('http://localhost:3001/summary');
                        summary.value = await res.json();
                    };

                    // ===========================
                    // ‚≠ê 5. Â∏∏Áî®Ê¨æÈ†ÖÂäüËÉΩ
                    // ===========================
                    const addToFavorites = (item) => {
                        const favorites = JSON.parse(localStorage.getItem('favoritePayments') || '[]');
                        // ÁµÑÊàêÊñ∞ÁöÑ favorite Ê¢ùÁõÆ
                        const fav = {
                            payer_id: item.payer_id,
                            amount: item.amount,
                            category: item.category,
                            note: item.note,
                            split_by: item.split_by,
                            splitUsers: [],   // È†êË®≠Á©∫
                            splitRooms: []    // È†êË®≠Á©∫
                        };

                        if (item.split_by === 'user') {
                            // ‰∫∫È†≠ÂàÜÂ∏≥ÔºöÂ≠ò user id Èô£Âàó
                            fav.splitUsers = item.split_users.map(u => u.id);
                        } else {
                            // ÊàøÈñìÂàÜÂ∏≥ÔºöÂ≠ò room_id Èô£Âàó
                            fav.splitRooms = item.split_per_room.map(grp => grp.room_id);
                        }

                        favorites.push(fav);
                        localStorage.setItem('favoritePayments', JSON.stringify(favorites));
                        favoritePayments.value = favorites;
                        alert('‚úÖ Â∑≤Âä†ÂÖ•Â∏∏Áî®Ê¨æÈ†ÖÔºÅ');
                    };

                    const selectFavorite = (item) => {
                        newPayment.value = {
                            payer_id: item.payer_id,
                            amount: item.amount,
                            category: item.category,
                            note: item.note,
                            date: new Date().toISOString().slice(0, 10),
                            split_by: item.split_by,
                            splitUsers: item.splitUsers || [],
                            splitRooms: item.splitRooms || []
                        };
                        showFavorites.value = false;
                    };

                    const removeFavorite = (index) => {
                        if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂ∏∏Áî®Ê¨æÈ†ÖÂóéÔºü')) return;
                        favoritePayments.value.splice(index, 1);
                        localStorage.setItem('favoritePayments', JSON.stringify(favoritePayments.value));
                    };

                    // ===========================
                    // üì• 6. Â∞ÅÂ≠ò / ÈÇÑÂéü ÂäüËÉΩ
                    // ===========================
                    const archiveSelectedPayments = async () => {
                        if (!confirm(`Á¢∫ÂÆöË¶ÅÂ∞ÅÂ≠òÈÄô ${selectedPayments.value.length} Á≠ÜÊ¨æÈ†ÖÂóéÔºü`)) return;
                        for (const id of selectedPayments.value) {
                            await fetch(`http://localhost:3001/payments/${id}/archive`, { method: 'POST' });
                        }
                        selectedPayments.value = [];
                        await loadPayments();
                        await loadSummary();
                        await loadArchivedPayments();
                    };

                    const toggleSelectAll = (checked) => {
                        selectedPayments.value = checked ? payments.value.map(p => p.id) : [];
                    };

                    const loadArchivedPayments = async () => {
                        const res = await fetch('http://localhost:3001/payments-with-users?archived=1');
                        archivedPayments.value = await res.json();
                    };

                    const unarchiveSelectedPayments = async () => {
                        if (!archivedSelected.value.length) return;
                        if (!confirm(`Á¢∫ÂÆöË¶ÅÈÇÑÂéüÈÄô ${archivedSelected.value.length} Á≠ÜÊ¨æÈ†ÖÂóéÔºü`)) return;
                        for (const id of archivedSelected.value) {
                            await fetch(`http://localhost:3001/payments/${id}/unarchive`, { method: 'POST' });
                        }
                        archivedSelected.value = [];
                        await loadArchivedPayments();
                        await loadPayments();
                        await loadSummary();
                    };

                    const toggleArchivedSelectAll = (checked) => {
                        archivedSelected.value = checked ? archivedPayments.value.map(p => p.id) : [];
                    };

                    // ===========================
                    // üß∞ 7. Â∑•ÂÖ∑ÂáΩÂºè
                    // ===========================
                    const getUserName = (id) => {
                        const user = users.value.find(u => u.id === id);
                        return user ? user.name : 'Êú™Áü•‰ΩøÁî®ËÄÖ';
                    };

                    // ===========================
                    // üöÄ ÂàùÂßãÂåñÊéõËºâ
                    // ===========================
                    onMounted(() => {
                        loadUsers();
                        loadRooms();
                        loadPayments();
                        loadSummary();
                        favoritePayments.value = JSON.parse(localStorage.getItem('favoritePayments') || '[]');
                        loadArchivedPayments();
                    });

                    // ===========================
                    // üì§ ÂõûÂÇ≥Á∂ÅÂÆöË≥áÊñô
                    // ===========================
                    return {
                        users, newUser, addUser, deleteUser,
                        rooms, newRoom, addRoom, deleteRoom,
                        roomAssignments, assignUserToRoom, unbindUserFromRoom,
                        payments, newPayment, addPayment, deletePayment,
                        summary,
                        showFavorites, favoritePayments, addToFavorites, selectFavorite, removeFavorite,
                        showArchived, archivedPayments, archivedSelected,
                        selectedPayments, archiveSelectedPayments, toggleSelectAll, deleteArchivedPayment,
                        unarchiveSelectedPayments, toggleArchivedSelectAll,
                        getUserName,
                        getRoomNameById, getUsersInRoom,
                        showManage
                    };
                }
            }).mount('#app');
        </script>
</body>

</html>